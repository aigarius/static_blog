<html><body><p></p><p>If you thought that sticking a supported miniPCI wireless card into a HP nx6110 notebook and getting it to work is trivial or fast or well documented, then you are quite wrong! Let me walk people trough the misery here...</p> <hr> <p>So you have you great <a href="http://www.amazon.com/exec/obidos/redirect?link_code=ur2&amp;tag=aigariusmindb-20&amp;camp=1789&amp;creative=9325&amp;path=http%3A%2F%2Fwww.amazon.com%2Fgp%2Fproduct%2FB0007PGANE%2Fsr%3D8-1%2Fqid%3D1143251495%2Fref%3Dpd_bbs_1%3F%255Fencoding%3DUTF8">HP nx6110 notebook</a> with some kind of Linux installed. For this exercise we will assume that we have Ubuntu Dapper Drake here, but similar problems will happen anywhere else too. You have you shiny new <a href="http://www.amazon.com/exec/obidos/redirect?link_code=ur2&amp;tag=aigariusmindb-20&amp;camp=1789&amp;creative=9325&amp;path=http%3A%2F%2Fwww.amazon.com%2Fgp%2Fproduct%2FB000281Z8G%2Fref%3Dpd_sbs_pc_2%3F%255Fencoding%3DUTF8%26v%3Dglance%26n%3D172282">Intel PRO/Wireless 2200</a> card (or newer <a href="http://www.amazon.com/exec/obidos/redirect?link_code=ur2&amp;tag=aigariusmindb-20&amp;camp=1789&amp;creative=9325&amp;path=http%3A%2F%2Fwww.amazon.com%2Fgp%2Fproduct%2FB0003QER5K%2Fsr%3D1-1%2Fqid%3D1143251924%2Fref%3Dsr_1_1%3F%255Fencoding%3DUTF8%26s%3Dpc">IPW2915</a> that has even more problems) in miniPCI form factor. You open the back of your notebook, stick the card into the slot, attach leads from the antennae and ... the fun begins ...</p> <p>The first problem is that you were cheap and instead of buying HP branded IPW2200 card for 100$, you bought an OEM version for 20$. HP will not like that, so right on the boot up you will be greeted by: "104 unsuported wirless network device detected, system halted, remove device and restart". Friendly, ne? The best workaround to this problem can be found on a <a href="http://forums1.itrc.hp.com/service/forums/questionanswer.do?threadId=567021">HP forum</a> and it is to edit EEPROM of the miniPCI card so that it contains the PCI ID that the HP laptop BIOS expects it to contain. Neat :)</p> <p>WARNING: EEPROM contains lots of important data. Anything could happen if wrong values are put there.</p> <p>So, how will we do that? It is quite simple, really. First remove the card and boot your Ubuntu. We will use the new Linux 2.6.16 kernel. To add support to writing to EEPROM we will need <a href="http://stachon.webpark.cz/files/ipw-eeprom-write.patch">Martin Stachon's patch</a>, but we will have to modify it a bit so that it fits 2.6.16 kernel, so here is the updated patch:</p> <code><br>--- linux-2.6.16/drivers/net/wireless/ipw2200.c 2006-03-20 07:53:29.000000000 +0200<br>+++ linux-2.6.16.new/drivers/net/wireless/ipw2200.c     2006-03-24 22:07:12.000000000 +0200 <br>@@ -2345,6 +2345,8 @@<br>   * NOTE: To better understand how these functions work (i.e what is a chip<br>   *       select and why do have to keep driving the eeprom clock?), read<br>   *       just about any data sheet for a Microwire compatible EEPROM.<br> + *<br> + * The chip is 93C66 in 16x256 mode.   */<br>   /* write a 32 bit value into the indirect accessor register */ <br>@@ -2425,6 +2427,37 @@ <br>        return r;  }<br>+/* write 16 bits to the eeprom */<br>+static void eeprom_write_u16(struct ipw_priv* priv, u8 addr, u16 data) <br>+{ <br>+       int i; <br>+ <br>+       printk(KERN_INFO DRV_NAME " eeprom_write_u16(%02x, %04x) ", addr, data); <br>+ <br>+       /* write/erase enable */ <br>+       eeprom_op(priv, EEPROM_CMD_EWEN, EEPROM_CMD_EWEN_ADDR); <br>+       eeprom_disable_cs(priv); <br>+ <br>+       eeprom_op(priv, EEPROM_CMD_WRITE, addr); <br>+ <br>+       /* now the data bits follow */ <br>+       for ( i=15; i&gt;=0; i-- ) { <br>+               eeprom_write_bit(priv, ( (data&amp;(1&lt;&lt;i)) != 0 ) ? 1 : 0 ); <br>+       } <br>+ <br>+       /* CS needs to be taken low before next clock */ <br>+       eeprom_write_reg(priv,0); <br>+       eeprom_write_reg(priv,EEPROM_BIT_SK); <br>+ <br>+       msleep(10); /* wait for the write to complete */ <br>+ <br>+       eeprom_write_reg(priv,0); <br>+ <br>+       /* write/erase disable */ <br>+       eeprom_op(priv,EEPROM_CMD_EWDS,EEPROM_CMD_EWDS_ADDR); <br>+       eeprom_disable_cs(priv); <br>+} <br>+  /* helper function for pulling the mac address out of the private */  <br>   /* data's copy of the eeprom data                                 */  <br>static void eeprom_parse_mac(struct ipw_priv *priv, u8 * mac) <br>@@ -9946,19 +9979,45 @@<br>         return 0;  }  <br>+#define IPW2200_EEPROM_MAGIC     0x2200 <br>+#define CX2_CHECKSUM             0x0040 <br>static int ipw_ethtool_set_eeprom(struct net_device *dev, <br>                                  struct ethtool_eeprom *eeprom, u8 * bytes)<br>  {<br>         struct ipw_priv *p = ieee80211_priv(dev); <br>-       int i; <br>+        u8 wordoffset; <br>+        u16 w; <br>+        int i; <br>+ <br>+        if(eeprom-&gt;magic != IPW2200_EEPROM_MAGIC) <br>+                return -EINVAL;<br>          if (eeprom-&gt;offset + eeprom-&gt;len &gt; IPW_EEPROM_IMAGE_SIZE)<br>                 return -EINVAL; <br>+ <br>+        wordoffset = eeprom-&gt;offset / 2; <br>+ <br>+        /* TODO ethtool currently supports writing only 1 byte, <br>+         * take eeprom-&gt;len into account */ <br>+ <br>+        if (eeprom-&gt;offset % 2 == 0) /* LSB */ <br>+                w = (p-&gt;eeprom[(eeprom-&gt;offset)+1] &lt;&lt; 8 ) | *bytes; <br>+        else /* MSB */ <br>+                w = p-&gt;eeprom[(eeprom-&gt;offset)-1] | (*bytes &lt;&lt; 8 );         down(&amp;p-&gt;sem); <br>+        eeprom_write_u16(p, wordoffset, w);         memcpy(&amp;p-&gt;eeprom[eeprom-&gt;offset], bytes, eeprom-&gt;len); <br>-       for (i = IPW_EEPROM_DATA; <br>-            i &lt; IPW_EEPROM_DATA + IPW_EEPROM_IMAGE_SIZE; i++) <br>-               ipw_write8(p, i, p-&gt;eeprom[i]); <br>+        if (wordoffset &gt; CX2_CHECKSUM / 2) { <br>+                p-&gt;eeprom[CX2_CHECKSUM] = 0; <br>+                p-&gt;eeprom[CX2_CHECKSUM+1] = 0; <br>+                for (i = CX2_CHECKSUM+2; i &lt; IPW_EEPROM_IMAGE_SIZE; i+=2) { <br>+                        p-&gt;eeprom[CX2_CHECKSUM] ^= p-&gt;eeprom[i]; <br>+                        p-&gt;eeprom[CX2_CHECKSUM+1] ^= p-&gt;eeprom[i+1]; <br>+                } <br>+                eeprom_write_u16(p, CX2_CHECKSUM/2, (p-&gt;eeprom[CX2_CHECKSUM+1] &lt;&lt; 8 ) | p-&gt;eeprom[CX2_CHECKSUM]); <br>+                IPW_ERROR("New EEPROM Checksum %04x ", (p-&gt;eeprom[CX2_CHECKSUM+1] &lt;&lt; 8 ) | p-&gt;eeprom[CX2_CHECKSUM]); <br>+        }<br>         up(&amp;p-&gt;sem);<br>         return 0;<br>  }</code>
<p>diff -u linux-2.6.16/drivers/net/wireless/ipw2200.h linux-2.6.16.new/drivers/net/wireless/ipw2200.h <br>--- linux-2.6.16/drivers/net/wireless/ipw2200.h 2006-03-20 07:53:29.000000000 +0200 <br>+++ linux-2.6.16.new/drivers/net/wireless/ipw2200.h     2006-03-24 21:15:47.000000000 +0200 <br>@@ -1583,6 +1583,13 @@  <br>#define EEPROM_BIT_DO                   (1&lt;&lt;4)   <br>#define EEPROM_CMD_READ                 0x2 <br>+#define EEPROM_CMD_WRITE                0x1 <br>+#define EEPROM_CMD_EWEN                 0x0 /* write/erase enable */ <br>+#define EEPROM_CMD_EWDS                 0x0 /* write/erase disable */ <br>+ <br>+/* these latter two are distinguished by two upper bits in address */ <br>+#define EEPROM_CMD_EWEN_ADDR            0xC0 <br>+#define EEPROM_CMD_EWDS_ADDR            0x00   /* Interrupts masks */  <br>#define IPW_INTA_NONE   0x00000000 <br></p> <p>Now that the kernel is patched with this patch, configure it, but be very careful to configure both ipw2200 and ieee80211 as modules and _not_ compiled into the kernel. Compile and install the kernel as usual. Also download IPW2200 <a href="http://ipw2200.sourceforge.net/firmware.php">firmware</a> and place it into /lib/firmware/.</p> <p>Turn off your computer and prepare for hot insertion of the card - remove the miniPCI slots cover, insert your IPW2200 card into the slot, attach the antennae and then eject it from the slot, but leave it just there. Turn on the computer and press "Esc" to get into GRUB bootup menu. At this point turn over your computer and insert the IPW2200 card into the slot while the computer is still running. Be very careful about static electricity and try not to touch any contacts - you can easily fry your notebook if you do something stupid here. When the card is inserted, boot your new kernel.</p> <p>The card should come up normally. The main check at this point is running "iwconfig" (all commands as root) to see which interface is your wireless card (it was "eth1" for me, substitute "eth1" for your interface name further on if you have a different one) and then running "ethtool -e eth1" to see a hex dump of the EEPROM of the WiFi card. If you get only bunch of zeros, then something is wrong there - maybe your firmware does not match with your driver version. Save the hex dump to a file - you might need it if you do something wrong with it later.</p> <p>Now it is the time to actually change the data in EEPROM. The commands to get a HP approved European version of IPW2200 card</p> <br><code> <br>ethtool -E eth1 magic 0x2200 offset 0x8 value 0xf6 <br>ethtool -E eth1 magic 0x2200 offset 0x9 value 0x12 <br>ethtool -E eth1 magic 0x2200 offset 0xa value 0x3c <br>ethtool -E eth1 magic 0x2200 offset 0xb value 0x10 <br></code> <br><p>To get HP approved USA version of IPW2200</p> <br><code> <br>ethtool -E eth1 magic 0x2200 offset 0x8 value 0xf5 <br>ethtool -E eth1 magic 0x2200 offset 0x9 value 0x12 <br>ethtool -E eth1 magic 0x2200 offset 0xa value 0x3c <br>ethtool -E eth1 magic 0x2200 offset 0xb value 0x10 <br></code><br> <p>At this point it should be safe to reboot your system with the card inside and the BIOS error should be no problem for you any more. Once a card has been altered this way it can be used in any HP notebook in any OS.</p> <p>However if you are like me then another stumbling block will be in your way: Kill switch. HP nx6110 has a switch in BIOS that permanently switches off miniPCI WiFi. The drives sees that as hardware kill switch. And of course I had to spend an hour until I figured that I had disabled that option in the BIOS "to save a bit of power" several months ago.</p> <p>To gain some extra geekness points you should also download and compile the newest versions of <a href="http://ieee80211.sf.net/">ieee80211</a> and ipw2200 driver with the newest <a href="http://ipw2200.sourceforge.net/firmware.php">firmware</a>, but remember that you will need to erase the modules that you built from your kernel tree and also comment out some options in few kernel config files. The installation docs of ipw2200 have all the details on that. And also do not forget to get a newer version of the firmware to go with those drivers.</p> <p>After I had done all those manipulations and also enabled ipw2200 drivers led option I gained fully functional WiFi card with fully functional LED indication and working software kill switch - I press the WiFi button and the radio goes off (along with the indicator LED), I press it again and the LED starts blinking and when the card associates with an access point the LED lights up fully in its great wireless glory.</p> <p>If your IPW2200 minPCI card still does not work, then check again if you have the firmware in place and then see what "dmesg" says to you after you tried to load the drivers.</p> <p>HP, this is really <em>not</em> nice at all!</p></body></html>